pipeline { 
    agent any 
    options {
        checkoutToSubdirectory('app')
    }
    stages {
        stage('Source Code Preparation') { 
            steps { 
                checkout scm
                sh "git rev-parse --short HEAD > .git/commit-id"
                script {
                    env.commit_id = readFile('.git/commit-id').trim()
                }
            }
        }
        dir ('./app'){
            stage('Unit test'){
                steps {
                    def myTestContainer = docker.image('node:9.11.1')
                    myTestContainer.pull()
                    myTestContainer.inside {
                      sh 'npm install --dev'
                      sh 'npm test'
                    }
                }
            }
            stage('Push Docker Image') {
                steps {
                    docker.withRegistry('https://137.116.133.205:8443/v2/', 'DTRcredential') {
                      def app = docker.build("admin/owaspweb:${commit_id}", '.').push()
                    }
                }
            }
            stage('Deploy to Docker Cluster') {
                steps {
                    sh "commit_id=${commit_id} docker stack deploy --compose-file docker-compose.yml owaspweb"
                }
            }
        }
    }
}